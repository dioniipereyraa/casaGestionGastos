<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏠 Casa Gastos - Gestión del Hogar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <% if (process.env.NODE_ENV === 'production') { %>
        <link href="/css/casa-gastos.min.css" rel="stylesheet">
    <% } else { %>
        <link href="/css/casa-gastos.css" rel="stylesheet">
    <% } %>
</head>
<body class="bg-light">
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-center">
                        <h2 class="mb-0"><i class="bi bi-house-heart"></i> Familia Pereyra Bocchio Gastos - Gestión del Hogar</h2>
                        <small>Que no se te pase nada</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas principales -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stats-card gastos-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-down-circle text-danger fs-1"></i>
                        <h5 class="card-title mt-2">Gastos del Mes</h5>
                        <h4 class="text-danger">$<%= parseFloat(totalGastosMes).toLocaleString('es-AR') %></h4>
                        <small class="text-muted">Total gastado este mes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card ingresos-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-up-circle text-success fs-1"></i>
                        <h5 class="card-title mt-2">Ingresos del Mes</h5>
                        <h4 class="text-success">$<%= parseFloat(totalIngresosMes).toLocaleString('es-AR') %></h4>
                        <small class="text-muted">Total ingresado este mes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card balance-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-calculator text-info fs-1"></i>
                        <h5 class="card-title mt-2">Balance del Mes</h5>
                        <h4 class="<%= balanceMes >= 0 ? 'balance-positivo' : 'balance-negativo' %>">
                            $<%= parseFloat(balanceMes).toLocaleString('es-AR') %>
                        </h4>
                        <small class="text-muted">Ingresos - Gastos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100" style="border-left-color: #6f42c1;">
                    <div class="card-body text-center">
                        <i class="bi bi-piggy-bank text-purple fs-1" style="color: #6f42c1;"></i>
                        <h5 class="card-title mt-2">Balance Total</h5>
                        <h4 class="<%= balanceGeneral >= 0 ? 'balance-positivo' : 'balance-negativo' %>">
                            $<%= parseFloat(balanceGeneral).toLocaleString('es-AR') %>
                        </h4>
                        <small class="text-muted">Saldo acumulado</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navegación por pestañas -->
        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gastos-tab" data-bs-toggle="pill" data-bs-target="#gastos" type="button" role="tab">
                    <i class="bi bi-arrow-down-circle"></i> Gastos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ingresos-tab" data-bs-toggle="pill" data-bs-target="#ingresos" type="button" role="tab">
                    <i class="bi bi-arrow-up-circle"></i> Ingresos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="categorias-tab" data-bs-toggle="pill" data-bs-target="#categorias" type="button" role="tab">
                    <i class="bi bi-tags"></i> Categorías
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-tab" data-bs-toggle="pill" data-bs-target="#ai" type="button" role="tab">
                    <i class="bi bi-robot"></i> AI Scanner
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="pills-tabContent">
            <!-- Dashboard -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <!-- Gastos por categoría -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Gastos por Categoría (Este Mes)</h5>
                            </div>
                            <div class="card-body">
                                <% if (gastosPorCategoria.length > 0) { %>
                                    <% gastosPorCategoria.forEach(categoria => { %>
                                        <div class="category-stats">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="categoria-badge" style="background-color: <%= categoria.color %>">
                                                        <%= categoria.nombre %>
                                                    </span>
                                                </div>
                                                <strong>$<%= parseFloat(categoria.total).toLocaleString('es-AR') %></strong>
                                            </div>
                                            <div class="progress mt-2" style="height: 8px;">
                                                <div class="progress-bar" 
                                                     style="width: <%= totalGastosMes > 0 ? (categoria.total/totalGastosMes*100) : 0 %>%; background-color: <%= categoria.color %>">
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <p class="text-muted text-center">No hay gastos registrados este mes</p>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Últimos movimientos -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Últimos Movimientos</h5>
                            </div>
                            <div class="card-body">
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <% 
                                    // Combinar gastos e ingresos y ordenar por fecha
                                    let movimientos = [];
                                    gastos.slice(0, 5).forEach(gasto => {
                                        movimientos.push({
                                            tipo: 'gasto',
                                            fecha: gasto.fecha_gasto,
                                            descripcion: gasto.descripcion,
                                            monto: gasto.monto,
                                            categoria: gasto.categoria_nombre,
                                            color: gasto.categoria_color
                                        });
                                    });
                                    ingresos.slice(0, 5).forEach(ingreso => {
                                        movimientos.push({
                                            tipo: 'ingreso',
                                            fecha: ingreso.fecha_ingreso,
                                            descripcion: ingreso.descripcion,
                                            monto: ingreso.monto,
                                            categoria: ingreso.categoria_nombre,
                                            color: ingreso.categoria_color
                                        });
                                    });
                                    movimientos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                                    %>
                                    
                                    <% movimientos.slice(0, 10).forEach(mov => { %>
                                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                            <div>
                                                <div class="fw-bold">
                                                    <i class="bi bi-<%= mov.tipo === 'gasto' ? 'arrow-down' : 'arrow-up' %> text-<%= mov.tipo === 'gasto' ? 'danger' : 'success' %>"></i>
                                                    <%= mov.descripcion %>
                                                </div>
                                                <small class="text-muted">
                                                    <%= new Date(mov.fecha).toLocaleDateString() %>
                                                    <% if (mov.categoria) { %>
                                                        • <span class="categoria-badge" style="background-color: <%= mov.color %>"><%= mov.categoria %></span>
                                                    <% } %>
                                                </small>
                                            </div>
                                            <strong class="text-<%= mov.tipo === 'gasto' ? 'danger' : 'success' %>">
                                                <%= mov.tipo === 'gasto' ? '-' : '+' %>$<%= parseFloat(mov.monto).toLocaleString('es-AR') %>
                                            </strong>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Income Flow Chart -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Flujo de Ingresos y Gastos (Este Mes)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-9 col-12">
                                        <div id="sankeyChart" style="width: 100%; height: 400px;"></div>
                                    </div>
                                    <div class="col-md-3 d-none d-md-block">
                                        <div class="flow-legend">
                                            <h6><i class="bi bi-info-circle"></i> Resumen del Flujo</h6>
                                            <div class="flow-summary">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="bi bi-arrow-up-circle text-success"></i> Total Ingresos:</span>
                                                    <strong class="text-success">$<%= parseFloat(totalIngresosMes).toLocaleString('es-AR') %></strong>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="bi bi-arrow-down-circle text-danger"></i> Total Gastos:</span>
                                                    <strong class="text-danger">$<%= parseFloat(totalGastosMes).toLocaleString('es-AR') %></strong>
                                                </div>
                                                <hr>
                                                <div class="d-flex justify-content-between">
                                                    <span><i class="bi bi-calculator"></i> Balance Final:</span>
                                                    <strong class="<%= balanceMes >= 0 ? 'text-success' : 'text-danger' %>">
                                                        $<%= parseFloat(balanceMes).toLocaleString('es-AR') %>
                                                    </strong>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <h6><i class="bi bi-tags"></i> Principales Categorías</h6>
                                                <div class="flow-categories">
                                                    <% if (gastosPorCategoria.length > 0) { %>
                                                        <% gastosPorCategoria.slice(0, 3).forEach(categoria => { %>
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <small>
                                                                    <span class="categoria-badge" style="background-color: <%= categoria.color %>; font-size: 0.7em;">
                                                                        <%= categoria.nombre %>
                                                                    </span>
                                                                </small>
                                                                <small class="text-danger">$<%= parseFloat(categoria.total).toLocaleString('es-AR') %></small>
                                                            </div>
                                                        <% }) %>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña Gastos -->
            <div class="tab-pane fade" id="gastos" role="tabpanel">
                <div class="row">
                    <!-- Formulario agregar gasto -->
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Agregar Gasto</h5>
                            </div>
                            <div class="card-body">
                                <form action="/agregar-gasto" method="POST">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="descripcion" name="descripcion" placeholder="Descripción" required>
                                        <label for="descripcion">Descripción del gasto</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <input type="number" class="form-control" id="monto" name="monto" min="0" max="999999999" placeholder="Monto" required>
                                        <label for="monto">Monto ($)</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <select class="form-select" id="categoria_id" name="categoria_id">
                                            <option value="">Sin categoría</option>
                                            <% categorias.filter(c => c.tipo_categoria === 'gasto').forEach(categoria => { %>
                                                <option value="<%= categoria.id %>"><%= categoria.nombre %></option>
                                            <% }) %>
                                        </select>
                                        <label for="categoria_id">Categoría</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <select class="form-select" id="tipo_gasto" name="tipo_gasto">
                                            <option value="variable">Variable</option>
                                            <option value="fijo">Fijo</option>
                                        </select>
                                        <label for="tipo_gasto">Tipo de gasto</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <input type="date" class="form-control" id="fecha_gasto" name="fecha_gasto" value="<%= new Date().toISOString().split('T')[0] %>" required>
                                        <label for="fecha_gasto">Fecha</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <select class="form-select" id="metodo_pago" name="metodo_pago">
                                            <option value="efectivo">Efectivo</option>
                                            <option value="tarjeta_debito">Tarjeta de Débito</option>
                                            <option value="tarjeta_credito">Tarjeta de Crédito</option>
                                            <option value="transferencia">Transferencia</option>
                                            <option value="otro">Otro</option>
                                        </select>
                                        <label for="metodo_pago">Método de pago</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <textarea class="form-control" id="observaciones" name="observaciones" style="height: 100px"></textarea>
                                        <label for="observaciones">Observaciones (opcional)</label>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-danger w-100">
                                        <i class="bi bi-plus-circle"></i> Agregar Gasto
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de gastos -->
                    <div class="col-md-8 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Gastos</h5>
                                <span class="badge bg-danger">Total: $<%= parseFloat(totalGastosGeneral).toLocaleString('es-AR') %></span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Descripción</th>
                                                <th>Categoría</th>
                                                <th>Tipo</th>
                                                <th>Método</th>
                                                <th>Monto</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (gastos.length > 0) { %>
                                                <% gastos.forEach(gasto => { %>
                                                    <tr>
                                                        <td><%= new Date(gasto.fecha_gasto).toLocaleDateString() %></td>
                                                        <td>
                                                            <%= gasto.descripcion %>
                                                            <% if (gasto.observaciones) { %>
                                                                <br><small class="text-muted"><%= gasto.observaciones %></small>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <% if (gasto.categoria_nombre) { %>
                                                                <span class="categoria-badge" style="background-color: <%= gasto.categoria_color %>">
                                                                    <%= gasto.categoria_nombre %>
                                                                </span>
                                                            <% } else { %>
                                                                <span class="text-muted">Sin categoría</span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-<%= gasto.tipo_gasto === 'fijo' ? 'warning' : 'secondary' %>">
                                                                <%= gasto.tipo_gasto %>
                                                            </span>
                                                        </td>
                                                        <td><%= gasto.metodo_pago.replace('_', ' ') %></td>
                                                        <td class="text-danger fw-bold">$<%= parseFloat(gasto.monto).toLocaleString('es-AR') %></td>
                                                        <td>
                                                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarGasto(<%= gasto.id %>)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                <% }) %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted">No hay gastos registrados</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña Ingresos -->
            <div class="tab-pane fade" id="ingresos" role="tabpanel">
                <div class="row">
                    <!-- Formulario agregar ingreso -->
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Agregar Ingreso</h5>
                            </div>
                            <div class="card-body">
                                <form action="/agregar-ingreso" method="POST">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="descripcion_ingreso" name="descripcion" placeholder="Descripción" required>
                                        <label for="descripcion_ingreso">Descripción del ingreso</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <input type="number" class="form-control" id="monto_ingreso" name="monto" min="0" max="999999999" placeholder="Monto" required>
                                        <label for="monto_ingreso">Monto ($)</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <select class="form-select" id="categoria_id_ingreso" name="categoria_id">
                                            <option value="">Sin categoría</option>
                                            <% categorias.filter(c => c.tipo_categoria === 'ingreso').forEach(categoria => { %>
                                                <option value="<%= categoria.id %>"><%= categoria.nombre %></option>
                                            <% }) %>
                                        </select>
                                        <label for="categoria_id_ingreso">Categoría</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <select class="form-select" id="tipo_ingreso" name="tipo_ingreso">
                                            <option value="salario">Salario</option>
                                            <option value="freelance">Freelance</option>
                                            <option value="venta">Venta</option>
                                            <option value="inversion">Inversión</option>
                                            <option value="otro">Otro</option>
                                        </select>
                                        <label for="tipo_ingreso">Tipo de ingreso</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso" value="<%= new Date().toISOString().split('T')[0] %>" required>
                                        <label for="fecha_ingreso">Fecha</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="fuente" name="fuente" placeholder="Fuente">
                                        <label for="fuente">Fuente (opcional)</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <textarea class="form-control" id="observaciones_ingreso" name="observaciones" style="height: 100px"></textarea>
                                        <label for="observaciones_ingreso">Observaciones (opcional)</label>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="bi bi-plus-circle"></i> Agregar Ingreso
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de ingresos -->
                    <div class="col-md-8 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Ingresos</h5>
                                <span class="badge bg-success">Total: $<%= parseFloat(totalIngresosGeneral).toLocaleString('es-AR') %></span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Descripción</th>
                                                <th>Categoría</th>
                                                <th>Tipo</th>
                                                <th>Fuente</th>
                                                <th>Monto</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (ingresos.length > 0) { %>
                                                <% ingresos.forEach(ingreso => { %>
                                                    <tr>
                                                        <td><%= new Date(ingreso.fecha_ingreso).toLocaleDateString() %></td>
                                                        <td>
                                                            <%= ingreso.descripcion %>
                                                            <% if (ingreso.observaciones) { %>
                                                                <br><small class="text-muted"><%= ingreso.observaciones %></small>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <% if (ingreso.categoria_nombre) { %>
                                                                <span class="categoria-badge" style="background-color: <%= ingreso.categoria_color %>">
                                                                    <%= ingreso.categoria_nombre %>
                                                                </span>
                                                            <% } else { %>
                                                                <span class="text-muted">Sin categoría</span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-info">
                                                                <%= ingreso.tipo_ingreso %>
                                                            </span>
                                                        </td>
                                                        <td><%= ingreso.fuente || '-' %></td>
                                                        <td class="text-success fw-bold">$<%= parseFloat(ingreso.monto).toLocaleString('es-AR') %></td>
                                                        <td>
                                                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarIngreso(<%= ingreso.id %>)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                <% }) %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted">No hay ingresos registrados</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña Categorías -->
            <div class="tab-pane fade" id="categorias" role="tabpanel">
                <div class="row">
                    <!-- Formulario agregar categoría -->
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Agregar Categoría</h5>
                            </div>
                            <div class="card-body">
                                <form action="/agregar-categoria" method="POST">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="nombre_categoria" name="nombre" placeholder="Nombre" required>
                                        <label for="nombre_categoria">Nombre de la categoría</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <textarea class="form-control" id="descripcion_categoria" name="descripcion" style="height: 100px"></textarea>
                                        <label for="descripcion_categoria">Descripción (opcional)</label>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <select class="form-select" id="tipo_categoria" name="tipo_categoria">
                                            <option value="gasto">Gasto</option>
                                            <option value="ingreso">Ingreso</option>
                                        </select>
                                        <label for="tipo_categoria">Tipo</label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color" class="form-label">Color</label>
                                        <input type="color" class="form-control form-control-color" id="color" name="color" value="#007bff">
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-plus-circle"></i> Agregar Categoría
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de categorías -->
                    <div class="col-md-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-tags"></i> Categorías Existentes</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-danger"><i class="bi bi-arrow-down-circle"></i> Categorías de Gastos</h6>
                                        <% categorias.filter(c => c.tipo_categoria === 'gasto').forEach(categoria => { %>
                                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                                <div>
                                                    <span class="categoria-badge" style="background-color: <%= categoria.color %>">
                                                        <%= categoria.nombre %>
                                                    </span>
                                                    <% if (categoria.descripcion) { %>
                                                        <br><small class="text-muted"><%= categoria.descripcion %></small>
                                                    <% } %>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="editarCategoria(<%= categoria.id %>)" title="Editar">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="eliminarCategoria(<%= categoria.id %>)" title="Eliminar">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        <% }) %>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success"><i class="bi bi-arrow-up-circle"></i> Categorías de Ingresos</h6>
                                        <% categorias.filter(c => c.tipo_categoria === 'ingreso').forEach(categoria => { %>
                                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                                <div>
                                                    <span class="categoria-badge" style="background-color: <%= categoria.color %>">
                                                        <%= categoria.nombre %>
                                                    </span>
                                                    <% if (categoria.descripcion) { %>
                                                        <br><small class="text-muted"><%= categoria.descripcion %></small>
                                                    <% } %>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="editarCategoria(<%= categoria.id %>)" title="Editar">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="eliminarCategoria(<%= categoria.id %>)" title="Eliminar">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        <% }) %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña AI Scanner -->
            <div class="tab-pane fade" id="ai" role="tabpanel">
                <div class="row">
                    <!-- Sección de upload -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-robot"></i> AI Scanner - Facturas y Recibos</h5>
                            </div>
                            <div class="card-body">
                                <div class="ai-upload-area" onclick="document.getElementById('file-input').click()">
                                    <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                                    <h5 class="mt-3">Sube tu factura o recibo</h5>
                                    <p class="text-muted">Haz clic aquí o arrastra y suelta una imagen</p>
                                    <small class="text-muted">Formatos: JPG, PNG, PDF (máx. 5MB)</small>
                                </div>
                                
                                <input type="file" id="file-input" accept="image/*,.pdf" style="display: none;" onchange="procesarArchivo(this)">
                                
                                <div class="upload-progress mt-3">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <p class="text-center mt-2">Procesando con AI...</p>
                                </div>
                                
                                <div id="ai-result" class="ai-result" style="display: none;">
                                    <h6><i class="bi bi-check-circle text-success"></i> Resultado del análisis:</h6>
                                    <div id="ai-data"></div>
                                    <div class="mt-3">
                                        <button class="btn btn-success" onclick="confirmarGasto()">
                                            <i class="bi bi-check"></i> Confirmar y Agregar
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="resetearIA()">
                                            <i class="bi bi-arrow-clockwise"></i> Nuevo análisis
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial de análisis -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Análisis AI</h5>
                            </div>
                            <div class="card-body">
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-file-earmark-text fs-1"></i>
                                        <p class="mt-2">Los análisis aparecerán aquí</p>
                                        <small>Sube facturas o recibos para comenzar</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información sobre AI -->
                <div class="row">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-info-circle text-info"></i> ¿Cómo funciona el AI Scanner?</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <i class="bi bi-upload fs-2 text-primary"></i>
                                            <h6 class="mt-2">1. Sube tu documento</h6>
                                            <small class="text-muted">Facturas, recibos, boletas en imagen o PDF</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <i class="bi bi-cpu fs-2 text-warning"></i>
                                            <h6 class="mt-2">2. Procesamiento AI</h6>
                                            <small class="text-muted">Extrae automáticamente monto, fecha y categoría</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <i class="bi bi-check-circle fs-2 text-success"></i>
                                            <h6 class="mt-2">3. Confirma y guarda</h6>
                                            <small class="text-muted">Revisa los datos y agrégalos a tus gastos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar categoría -->
    <div class="modal fade" id="editarCategoriaModal" tabindex="-1" aria-labelledby="editarCategoriaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editarCategoriaModalLabel">
                        <i class="bi bi-pencil"></i> Editar Categoría
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarCategoria">
                        <input type="hidden" id="editCategoriaId" name="categoriaId">
                        
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="editNombreCategoria" name="nombre" placeholder="Nombre" required>
                            <label for="editNombreCategoria">Nombre de la categoría</label>
                        </div>
                        
                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="editDescripcionCategoria" name="descripcion" style="height: 100px"></textarea>
                            <label for="editDescripcionCategoria">Descripción (opcional)</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editColor" class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="editColor" name="color" value="#007bff">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de categoría</label>
                            <div class="form-control" id="editTipoCategoria" style="background-color: #f8f9fa; border: none;">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCambiosCategoria()">
                        <i class="bi bi-check-circle"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4 mt-5">
        <div class="container">
            <p class="text-muted mb-0">
                <i class="bi bi-house-heart"></i> Casa Gastos v1.0 - Gestiona las finanzas de tu hogar
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12/dist/d3-sankey.min.js"></script>
    <% if (process.env.NODE_ENV === 'production') { %>
        <script src="/js/casa-gastos.min.js"></script>
    <% } else { %>
        <script src="/js/casa-gastos.js"></script>
    <% } %>
</body>
</html>